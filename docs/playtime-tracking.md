# 游戏时长追踪功能说明

## 功能概述
该功能实现了用户登录后自动开始计时，退出登录后停止计时,并将游戏时长实时保存到Supabase数据库中。

## 实现原理

### 1. 核心组件
- **playtime-tracker.js**: 游戏时长追踪器核心模块
- **supabase.js**: 更新了updatePlayTime方法,支持实时更新游戏时长
- **login.html**: 登录成功后触发计时开始
- **game.html**: 游戏页面,加载后继续计时
- **control.js**: 返回登录时停止计时

### 2. 工作流程

#### 用户登录阶段
1. 用户在登录页面输入邮箱和密码
2. 登录成功后,触发`userLoggedIn`自定义事件
3. `playtime-tracker.js`接收到事件,开始计时
4. 记录登录时间戳到localStorage(用于页面刷新恢复)

#### 游戏进行中
1. 用户在各个页面间切换(游戏页面、排行榜、个人信息等)
2. 每30秒自动更新一次数据库中的游戏时长
3. 使用`localStorage`保存会话状态,页面刷新后可以恢复计时
4. 页面隐藏时(切换标签页)暂停定期更新,页面可见时恢复

#### 用户退出登录
1. 用户点击"返回登录"按钮
2. 调用`playtimeTracker.stopTracking()`停止计时
3. 计算当前会话总时长
4. 将最终时长保存到数据库
5. 清除localStorage中的会话状态

### 3. 数据存储

#### 数据库表: game_stats
- `user_id`: 用户ID
- `play_time`: 游戏总时长(秒)
- `level`: 用户等级(根据游戏时长自动计算)
- `login_days`: 累计登录天数(基于游戏总时长)

#### 等级计算公式
S(n) = n² + 4n
- n: 等级
- S(n): 升级到该等级所需的累计游戏时长(小时)

例如:
- 1级: 0-5小时
- 2级: 5-12小时
- 3级: 12-21小时
- ...

### 4. 实时更新机制

#### 定期更新
- 更新间隔: 30秒
- 更新方式: 调用`updatePlayTime()`方法
- 数据库触发器: 自动计算并更新用户等级

#### 会话恢复
- 页面刷新后检查localStorage中的会话状态
- 如果会话有效(不超过1小时),恢复计时
- 计算累计时长并更新数据库

#### 页面卸载处理
- 使用`navigator.sendBeacon`在页面卸载时发送数据
- 确保即使关闭标签页也能保存时长

## 文件修改清单

### 新增文件
1. `scripts/playtime-tracker.js` - 游戏时长追踪器核心模块

### 修改文件
1. `scripts/supabase.js`
   - 更新了`updatePlayTime()`方法,支持增量更新游戏时长

2. `pages/login.html`
   - 登录成功后触发`userLoggedIn`事件

3. `pages/game.html`
   - 引入`playtime-tracker.js`

4. `pages/leaderboard.html`
   - 引入`playtime-tracker.js`

5. `pages/userinfo.html`
   - 引入`playtime-tracker.js`

6. `scripts/control.js`
   - 返回登录按钮点击时停止计时并保存

## 测试方法

### 1. 登录测试
1. 打开登录页面
2. 输入正确的邮箱和密码
3. 点击登录按钮
4. 检查浏览器控制台,应该看到"开始游戏时长追踪..."日志

### 2. 计时测试
1. 登录后,在游戏页面停留一段时间
2. 检查控制台,每30秒应该看到"游戏时长已实时更新"日志
3. 刷新页面,计时应该继续,不丢失

### 3. 退出测试
1. 点击"返回登录"按钮
2. 检查控制台,应该看到"停止游戏时长追踪"和"游戏时长已保存"日志
3. 再次登录,检查数据库中的总时长是否正确增加

### 4. 数据库验证
```sql
-- 查询用户游戏时长
SELECT
    user_id,
    play_time / 3600.0 as total_hours,
    level,
    login_days
FROM public.game_stats
WHERE user_id = '<your_user_id>';

-- 查看用户等级信息
SELECT * FROM user_level_info WHERE user_id = '<your_user_id>';
```

## 注意事项

1. **权限要求**: 确保数据库表game_stats的RLS策略允许用户更新自己的记录
2. **网络稳定性**: 实时更新依赖网络,网络异常可能导致更新失败
3. **时区问题**: 所有时间戳使用UTC时区,避免时区转换问题
4. **会话超时**: 会话状态在localStorage中保存,最多1小时有效
5. **并发控制**: 如果用户在多个设备登录,可能导致时长计算不准确

## 故障排查

### 问题: 时长没有更新
- 检查控制台是否有错误日志
- 确认数据库连接正常
- 检查用户是否有更新权限

### 问题: 刷新页面后时长丢失
- 检查localStorage是否被禁用
- 确认playtimeSession键存在
- 检查会话是否超过1小时有效期

### 问题: 等级没有更新
- 检查数据库触发器是否正常工作
- 手动执行`SELECT update_user_level()`测试触发器
- 确认等级计算函数正确

## 后续优化建议

1. **离线支持**: 添加离线时本地存储,网络恢复后同步
2. **防作弊**: 添加异常检测,防止用户通过修改系统时间作弊
3. **详细日志**: 记录每次游戏的具体时长,用于数据分析
4. **统计图表**: 在个人信息页面显示游戏时长趋势图
5. **成就系统**: 根据游戏时长解锁成就
