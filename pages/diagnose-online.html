<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”æœºè¯Šæ–­å·¥å…· - Dual Showdown</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #ff6b6b;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section h2 {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .status-item {
            padding: 10px;
            margin: 10px 0;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            border-left: 4px solid #4ecdc4;
        }

        .status-item.success {
            border-left-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .status-item.error {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .status-item.warning {
            border-left-color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }

        .status-item.info {
            border-left-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .button {
            padding: 12px 24px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .button:hover {
            background: #ee5a5a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .button.secondary {
            background: #4ecdc4;
        }

        .button.secondary:hover {
            background: #45b7aa;
        }

        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry.error {
            color: #ff6b6b;
        }

        .log-entry.success {
            color: #2ecc71;
        }

        .log-entry.warning {
            color: #f39c12;
        }

        .log-entry.info {
            color: #3498db;
        }

        .test-result {
            margin: 10px 0;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }

        .test-result .title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .test-result .details {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }

        .solution-box {
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid #2ecc71;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .solution-box h3 {
            color: #2ecc71;
            margin-bottom: 10px;
        }

        .solution-box ol {
            margin-left: 20px;
        }

        .solution-box li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .code-block {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            border: 1px solid #444;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #2d2d2d;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ è”æœºå¯¹æˆ˜è¯Šæ–­å·¥å…·</h1>

        <!-- è¯Šæ–­æ§åˆ¶é¢æ¿ -->
        <div class="section">
            <h2>ğŸ“‹ è¯Šæ–­æ§åˆ¶</h2>
            <button class="button" onclick="runFullDiagnosis()">ğŸ” å¼€å§‹å…¨é¢è¯Šæ–­</button>
            <button class="button secondary" onclick="clearLogs()">ğŸ§¹ æ¸…é™¤æ—¥å¿—</button>
            <button class="button secondary" onclick="exportReport()">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
        </div>

        <!-- è¯Šæ–­è¿›åº¦ -->
        <div class="section">
            <h2>ğŸ“Š è¯Šæ–­è¿›åº¦</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
            <div id="progressStatus">ç­‰å¾…å¼€å§‹...</div>
        </div>

        <!-- è¯Šæ–­ç»“æœ -->
        <div class="section">
            <h2>âœ… è¯Šæ–­ç»“æœ</h2>
            <div id="diagnosisResults">
                <div class="status-item info">è¯·ç‚¹å‡»"å¼€å§‹å…¨é¢è¯Šæ–­"æŒ‰é’®å¼€å§‹æ£€æµ‹</div>
            </div>
        </div>

        <!-- è¯¦ç»†æ—¥å¿— -->
        <div class="section">
            <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
            <div class="log-container" id="logContainer">
                <div class="log-entry info">[ç³»ç»Ÿ] è¯Šæ–­å·¥å…·å·²å°±ç»ª</div>
            </div>
        </div>

        <!-- è§£å†³æ–¹æ¡ˆ -->
        <div class="section">
            <h2>ğŸ’¡ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</h2>

            <div class="solution-box">
                <h3>é—®é¢˜1ï¼šè®¿å®¢æ— æ³•åŠ å…¥æˆ¿é—´ï¼ˆguest_idæœªæ›´æ–°ï¼‰</h3>
                <p><strong>ç—‡çŠ¶ï¼š</strong>æˆ¿ä¸»æ˜¾ç¤º"ç­‰å¾…å¯¹æ‰‹åŠ å…¥"ï¼Œä½†è®¿å®¢è¾“å…¥æˆ¿é—´IDåæ— æ³•æˆåŠŸåŠ å…¥ã€‚</p>
                <p><strong>åŸå› ï¼š</strong>æ•°æ®åº“æƒé™ç­–ç•¥é™åˆ¶äº†è®¿å®¢æ›´æ–°æˆ¿é—´çš„æƒé™ã€‚</p>
                <h4>è§£å†³æ­¥éª¤ï¼š</h4>
                <ol>
                    <li>ç™»å½• Supabase æ§åˆ¶å°</li>
                    <li>è¿›å…¥ SQL ç¼–è¾‘å™¨</li>
                    <li>æ‰§è¡Œä»¥ä¸‹ SQL è„šæœ¬ï¼š</li>
                </ol>
                <div class="code-block">
-- åˆ é™¤æ—§çš„ç­–ç•¥
DROP POLICY IF EXISTS "Users can join rooms" ON public.game_rooms;

-- åˆ›å»ºæ–°çš„ç­–ç•¥ - å…è®¸ä»»ä½•ç”¨æˆ·åŠ å…¥ waiting çŠ¶æ€çš„æˆ¿é—´
CREATE POLICY "Users can join waiting rooms" ON public.game_rooms
FOR UPDATE
USING (
  auth.uid() = guest_id OR
  auth.uid() = host_id OR
  status = 'waiting'
)
WITH CHECK (
  auth.uid() = guest_id OR
  auth.uid() = host_id OR
  (
    status = 'ready' AND
    guest_id = auth.uid()
  )
);
                </div>
                <ol start="4">
                    <li>ç‚¹å‡»"Run"æ‰§è¡Œè„šæœ¬</li>
                    <li>è¿”å›æ¸¸æˆé¡µé¢ï¼Œé‡æ–°åˆ›å»ºæˆ¿é—´å¹¶æµ‹è¯•</li>
                </ol>
            </div>

            <div class="solution-box">
                <h3>é—®é¢˜2ï¼šå®æ—¶è®¢é˜…å¤±è´¥</h3>
                <p><strong>ç—‡çŠ¶ï¼š</strong>è®¿å®¢æˆåŠŸåŠ å…¥æˆ¿é—´ï¼Œä½†æˆ¿ä¸»ä¾§æ²¡æœ‰æ˜¾ç¤º"å¼€å§‹æ¸¸æˆ"æŒ‰é’®ã€‚</p>
                <p><strong>åŸå› ï¼š</strong>Supabase å®æ—¶è®¢é˜…å¯èƒ½å› ä¸ºç½‘ç»œæˆ–é…ç½®é—®é¢˜å¤±è´¥ã€‚</p>
                <h4>è§£å†³æ­¥éª¤ï¼š</h4>
                <ol>
                    <li>æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰è®¢é˜…é”™è¯¯</li>
                    <li>ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸</li>
                    <li>å¦‚æœé—®é¢˜æŒç»­ï¼Œåˆ·æ–°é¡µé¢åé‡æ–°åˆ›å»ºæˆ¿é—´</li>
                    <li>æ£€æŸ¥ Supabase é¡¹ç›®çš„ Realtime åŠŸèƒ½æ˜¯å¦å·²å¯ç”¨</li>
                </ol>
            </div>

            <div class="solution-box">
                <h3>é—®é¢˜3ï¼šæˆ¿é—´çŠ¶æ€è½®è¯¢å¤±è´¥</h3>
                <p><strong>ç—‡çŠ¶ï¼š</strong>æˆ¿é—´çŠ¶æ€æ£€æŸ¥è½®è¯¢æ²¡æœ‰æ­£å¸¸å·¥ä½œã€‚</p>
                <p><strong>åŸå› ï¼š</strong>å¯èƒ½æ˜¯ä»£ç é€»è¾‘é”™è¯¯æˆ–ç½‘ç»œå»¶è¿Ÿã€‚</p>
                <h4>è§£å†³æ­¥éª¤ï¼š</h4>
                <ol>
                    <li>æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„æ—¥å¿—è¾“å‡º</li>
                    <li>ç¡®è®¤æˆ¿é—´ ID æ ¼å¼æ­£ç¡®ï¼ˆ6ä½å¤§å†™å­—æ¯æ•°å­—ï¼‰</li>
                    <li>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡æ–°å°è¯•</li>
                    <li>ä½¿ç”¨ä¸åŒçš„æµè§ˆå™¨è¿›è¡Œæµ‹è¯•</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- åŠ è½½ Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // é…ç½®
        const SUPABASE_URL = 'https://vlturfwdcjlrsoswkzvr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsdHVyZndkY2pscnNvc3drenZyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjIyMjA2MiwiZXhwIjoyMDgxNzk4MDYyfQ.fZNNS_1n7HI4r9IaIydfaewXbvzwVonG8I8EGlTvqqc';

        let supabaseClient = null;
        let testResults = [];
        let currentStep = 0;
        let totalSteps = 8;

        // åˆå§‹åŒ–æ—¥å¿—
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(step, status) {
            const percentage = Math.round((step / totalSteps) * 100);
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressFill').textContent = percentage + '%';
            document.getElementById('progressStatus').textContent = status;
        }

        // æ·»åŠ è¯Šæ–­ç»“æœ
        function addResult(testName, passed, details, suggestions = '') {
            const resultsContainer = document.getElementById('diagnosisResults');
            const resultItem = document.createElement('div');
            resultItem.className = `test-result ${passed ? 'success' : 'error'}`;

            let html = `
                <div class="title">${passed ? 'âœ…' : 'âŒ'} ${testName}</div>
                <div class="details">${details}</div>
            `;

            if (suggestions && !passed) {
                html += `<div style="color: #f39c12; margin-top: 8px;"><strong>ğŸ’¡ å»ºè®®ï¼š</strong>${suggestions}</div>`;
            }

            resultItem.innerHTML = html;
            resultsContainer.appendChild(resultItem);

            testResults.push({
                testName,
                passed,
                details,
                suggestions
            });
        }

        // å…¨é¢è¯Šæ–­
        async function runFullDiagnosis() {
            try {
                // é‡ç½®
                testResults = [];
                document.getElementById('diagnosisResults').innerHTML = '';
                addLog('å¼€å§‹å…¨é¢è¯Šæ–­...', 'info');
                currentStep = 0;

                // æ­¥éª¤1ï¼šåˆå§‹åŒ– Supabase
                addLog('æ­¥éª¤ 1/8: åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯...', 'info');
                updateProgress(++currentStep, 'åˆå§‹åŒ– Supabase...');
                try {
                    const { createClient } = supabase;
                    supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    addLog('âœ“ Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                    addResult('Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–', true, 'Supabase SDK åŠ è½½æˆåŠŸï¼Œå¯ä»¥æ­£å¸¸åˆ›å»ºå®¢æˆ·ç«¯');
                } catch (error) {
                    addLog('âœ— Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                    addResult('Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–', false, 'é”™è¯¯: ' + error.message, 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }

                // æ­¥éª¤2ï¼šæ£€æŸ¥ç”¨æˆ·è®¤è¯
                addLog('æ­¥éª¤ 2/8: æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€...', 'info');
                updateProgress(++currentStep, 'æ£€æŸ¥ç”¨æˆ·è®¤è¯...');
                try {
                    const { data: { session }, error } = await supabaseClient.auth.getSession();
                    if (error) throw error;

                    if (session && session.user) {
                        addLog(`âœ“ ç”¨æˆ·å·²ç™»å½•: ${session.user.email}`, 'success');
                        addResult('ç”¨æˆ·è®¤è¯çŠ¶æ€', true, `ç”¨æˆ·å·²ç™»å½•: ${session.user.email}`);
                    } else {
                        addLog('âš  ç”¨æˆ·æœªç™»å½•', 'warning');
                        addResult('ç”¨æˆ·è®¤è¯çŠ¶æ€', false, 'ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æµ‹è¯•è”æœºåŠŸèƒ½', 'è¯·å…ˆç™»å½•æ¸¸æˆé¡µé¢ï¼Œç„¶åå†è¿è¡Œè¯Šæ–­');
                        return;
                    }
                } catch (error) {
                    addLog('âœ— æ£€æŸ¥ç”¨æˆ·è®¤è¯å¤±è´¥: ' + error.message, 'error');
                    addResult('ç”¨æˆ·è®¤è¯çŠ¶æ€', false, 'é”™è¯¯: ' + error.message);
                    return;
                }

                // æ­¥éª¤3ï¼šæ£€æŸ¥æ¸¸æˆæˆ¿é—´è¡¨
                addLog('æ­¥éª¤ 3/8: æ£€æŸ¥æ¸¸æˆæˆ¿é—´è¡¨...', 'info');
                updateProgress(++currentStep, 'æ£€æŸ¥æ•°æ®åº“è¡¨...');
                try {
                    const { data, error } = await supabaseClient
                        .from('game_rooms')
                        .select('*')
                        .limit(1);

                    if (error) {
                        if (error.code === '42P01') {
                            addLog('âœ— game_rooms è¡¨ä¸å­˜åœ¨', 'error');
                            addResult('æ¸¸æˆæˆ¿é—´è¡¨', false, 'game_rooms è¡¨ä¸å­˜åœ¨', 'è¯·è¿è¡Œ database/create_game_rooms.sql è„šæœ¬åˆ›å»ºè¡¨');
                        } else {
                            throw error;
                        }
                    } else {
                        addLog('âœ“ game_rooms è¡¨å­˜åœ¨', 'success');
                        addResult('æ¸¸æˆæˆ¿é—´è¡¨', true, 'game_rooms è¡¨å·²åˆ›å»º');
                    }
                } catch (error) {
                    addLog('âœ— æ£€æŸ¥è¡¨å¤±è´¥: ' + error.message, 'error');
                    addResult('æ¸¸æˆæˆ¿é—´è¡¨', false, 'é”™è¯¯: ' + error.message);
                    return;
                }

                // æ­¥éª¤4ï¼šæµ‹è¯•åˆ›å»ºæˆ¿é—´
                addLog('æ­¥éª¤ 4/8: æµ‹è¯•åˆ›å»ºæˆ¿é—´...', 'info');
                updateProgress(++currentStep, 'æµ‹è¯•åˆ›å»ºæˆ¿é—´...');
                const testRoomId = 'TEST' + Math.random().toString(36).substring(2, 8).toUpperCase();
                try {
                    const { data: { user } } = await supabaseClient.auth.getUser();

                    const { data, error } = await supabaseClient
                        .from('game_rooms')
                        .insert([
                            {
                                id: testRoomId,
                                host_id: user.id,
                                host_email: user.email,
                                status: 'waiting'
                            }
                        ]);

                    if (error) throw error;
                    addLog(`âœ“ æµ‹è¯•æˆ¿é—´åˆ›å»ºæˆåŠŸ: ${testRoomId}`, 'success');
                    addResult('åˆ›å»ºæˆ¿é—´æƒé™', true, 'å¯ä»¥æˆåŠŸåˆ›å»ºæˆ¿é—´ï¼ŒINSERT æƒé™æ­£å¸¸');
                } catch (error) {
                    addLog('âœ— åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + error.message, 'error');
                    addResult('åˆ›å»ºæˆ¿é—´æƒé™', false, 'é”™è¯¯: ' + error.message, 'è¯·æ£€æŸ¥"Users can create rooms"ç­–ç•¥æ˜¯å¦æ­£ç¡®é…ç½®');
                    return;
                }

                // æ­¥éª¤5ï¼šæµ‹è¯•è¯»å–æˆ¿é—´
                addLog('æ­¥éª¤ 5/8: æµ‹è¯•è¯»å–æˆ¿é—´...', 'info');
                updateProgress(++currentStep, 'æµ‹è¯•è¯»å–æˆ¿é—´...');
                try {
                    const { data, error } = await supabaseClient
                        .from('game_rooms')
                        .select('*')
                        .eq('id', testRoomId)
                        .single();

                    if (error) throw error;
                    addLog('âœ“ å¯ä»¥è¯»å–æˆ¿é—´æ•°æ®', 'success');
                    addLog(`  æˆ¿é—´ä¿¡æ¯: ID=${data.id}, çŠ¶æ€=${data.status}, æˆ¿ä¸»=${data.host_email}`, 'info');
                    addResult('è¯»å–æˆ¿é—´æƒé™', true, 'SELECT æƒé™æ­£å¸¸');
                } catch (error) {
                    addLog('âœ— è¯»å–æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
                    addResult('è¯»å–æˆ¿é—´æƒé™', false, 'é”™è¯¯: ' + error.message);
                }

                // æ­¥éª¤6ï¼šæµ‹è¯•åŠ å…¥æˆ¿é—´ï¼ˆå…³é”®æ­¥éª¤ï¼‰
                addLog('æ­¥éª¤ 6/8: æµ‹è¯•åŠ å…¥æˆ¿é—´ï¼ˆæ¨¡æ‹Ÿè®¿å®¢ï¼‰...', 'info');
                updateProgress(++currentStep, 'æµ‹è¯•åŠ å…¥æˆ¿é—´...');
                try {
                    const { data, error } = await supabaseClient
                        .from('game_rooms')
                        .update({
                            guest_id: testRoomId + 'GUEST', // ä½¿ç”¨ä¸åŒçš„IDæ¨¡æ‹Ÿè®¿å®¢
                            status: 'ready'
                        })
                        .eq('id', testRoomId);

                    if (error) {
                        addLog('âœ— æ›´æ–°æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
                        addLog('  é”™è¯¯ä»£ç : ' + error.code, 'error');
                        addLog('  é”™è¯¯è¯¦æƒ…: ' + JSON.stringify(error), 'error');
                        addResult('è®¿å®¢åŠ å…¥æˆ¿é—´æƒé™', false, 'é”™è¯¯: ' + error.message, 'è¿™æ˜¯æœ€å¸¸è§çš„é—®é¢˜ï¼è¯·è¿è¡Œ database/fix_join_policy.sql è„šæœ¬ä¿®å¤æƒé™ç­–ç•¥');
                    } else {
                        addLog('âœ“ å¯ä»¥æ›´æ–°æˆ¿é—´ï¼ˆæ¨¡æ‹Ÿè®¿å®¢åŠ å…¥ï¼‰', 'success');
                        addResult('è®¿å®¢åŠ å…¥æˆ¿é—´æƒé™', true, 'UPDATE æƒé™æ­£å¸¸ï¼Œè®¿å®¢å¯ä»¥æˆåŠŸåŠ å…¥æˆ¿é—´');
                    }
                } catch (error) {
                    addLog('âœ— åŠ å…¥æˆ¿é—´æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                    addResult('è®¿å®¢åŠ å…¥æˆ¿é—´æƒé™', false, 'é”™è¯¯: ' + error.message, 'è¯·è¿è¡Œ database/fix_join_policy.sql è„šæœ¬ä¿®å¤æƒé™ç­–ç•¥');
                }

                // æ­¥éª¤7ï¼šæµ‹è¯•å®æ—¶è®¢é˜…
                addLog('æ­¥éª¤ 7/8: æµ‹è¯•å®æ—¶è®¢é˜…...', 'info');
                updateProgress(++currentStep, 'æµ‹è¯•å®æ—¶è®¢é˜…...');
                try {
                    const channel = supabaseClient
                        .channel('test-channel')
                        .on('postgres_changes',
                            { event: '*', schema: 'public', table: 'game_rooms' },
                            (payload) => {
                                addLog('âœ“ æ”¶åˆ°å®æ—¶æ›´æ–°: ' + JSON.stringify(payload), 'success');
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                addLog('âœ“ å®æ—¶è®¢é˜…æˆåŠŸ', 'success');
                                addResult('å®æ—¶è®¢é˜…åŠŸèƒ½', true, 'Realtime åŠŸèƒ½æ­£å¸¸å·¥ä½œ');
                            } else if (status === 'CHANNEL_ERROR') {
                                addLog('âœ— å®æ—¶è®¢é˜…å¤±è´¥', 'error');
                                addResult('å®æ—¶è®¢é˜…åŠŸèƒ½', false, 'è®¢é˜…çŠ¶æ€: ' + status, 'è¯·æ£€æŸ¥ Supabase é¡¹ç›®çš„ Realtime åŠŸèƒ½æ˜¯å¦å·²å¯ç”¨');
                            }
                        });

                    // ç­‰å¾…è®¢é˜…å®Œæˆ
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // å–æ¶ˆè®¢é˜…
                    supabaseClient.removeChannel(channel);
                } catch (error) {
                    addLog('âœ— å®æ—¶è®¢é˜…æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                    addResult('å®æ—¶è®¢é˜…åŠŸèƒ½', false, 'é”™è¯¯: ' + error.message, 'è¯·æ£€æŸ¥ Supabase é¡¹ç›®çš„ Realtime åŠŸèƒ½æ˜¯å¦å·²å¯ç”¨');
                }

                // æ­¥éª¤8ï¼šæ¸…ç†æµ‹è¯•æ•°æ®
                addLog('æ­¥éª¤ 8/8: æ¸…ç†æµ‹è¯•æ•°æ®...', 'info');
                updateProgress(++currentStep, 'æ¸…ç†æµ‹è¯•æ•°æ®...');
                try {
                    const { error } = await supabaseClient
                        .from('game_rooms')
                        .delete()
                        .eq('id', testRoomId);

                    if (error) {
                        addLog('âš  æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message, 'warning');
                        addLog('  è¯·æ‰‹åŠ¨åˆ é™¤æµ‹è¯•æˆ¿é—´: ' + testRoomId, 'warning');
                    } else {
                        addLog('âœ“ æµ‹è¯•æ•°æ®å·²æ¸…ç†', 'success');
                    }
                } catch (error) {
                    addLog('âš  æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message, 'warning');
                }

                // å®Œæˆ
                updateProgress(totalSteps, 'è¯Šæ–­å®Œæˆï¼');
                addLog('========== è¯Šæ–­å®Œæˆ ==========', 'success');

                const passedTests = testResults.filter(r => r.passed).length;
                const failedTests = testResults.length - passedTests;

                addLog(`æ€»è®¡: ${testResults.length} é¡¹æµ‹è¯•`, 'info');
                addLog(`é€šè¿‡: ${passedTests} é¡¹`, failedTests === 0 ? 'success' : 'warning');
                addLog(`å¤±è´¥: ${failedTests} é¡¹`, failedTests > 0 ? 'error' : 'info');

                if (failedTests > 0) {
                    addLog('', 'info');
                    addLog('âš  æ£€æµ‹åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„"è¯Šæ–­ç»“æœ"å’Œ"å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ"éƒ¨åˆ†', 'warning');
                } else {
                    addLog('', 'info');
                    addLog('ğŸ‰ æ‰€æœ‰æ£€æµ‹é¡¹éƒ½é€šè¿‡äº†ï¼è”æœºåŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œã€‚', 'success');
                }

            } catch (error) {
                addLog('âœ— è¯Šæ–­è¿‡ç¨‹å‡ºé”™: ' + error.message, 'error');
                addLog('é”™è¯¯å †æ ˆ: ' + error.stack, 'error');
            }
        }

        // å¯¼å‡ºæŠ¥å‘Š
        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                testResults: testResults,
                summary: {
                    total: testResults.length,
                    passed: testResults.filter(r => r.passed).length,
                    failed: testResults.filter(r => !r.passed).length
                }
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dual-showdown-diagnosis-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            addLog('è¯Šæ–­æŠ¥å‘Šå·²å¯¼å‡º', 'success');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æç¤º
        window.addEventListener('load', function() {
            addLog('è¯Šæ–­å·¥å…·åŠ è½½å®Œæˆ', 'success');
            addLog('ç‚¹å‡»"å¼€å§‹å…¨é¢è¯Šæ–­"æŒ‰é’®å¼€å§‹æ£€æµ‹', 'info');
        });
    </script>
</body>
</html>
