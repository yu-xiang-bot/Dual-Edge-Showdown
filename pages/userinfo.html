<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Supabaseæ•°æ®åº“è¿æ¥ -->
  <script src="../scripts/supabase.js"></script>
  <script src="../scripts/playtime-tracker.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¿¡æ¯ - Dual Edge Showdown</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', 'Arial', sans-serif;
            background-image: url('../assets/images/userBcke.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(15, 15, 25, 0.4), rgba(30, 30, 40, 0.3));
            z-index: -1;
        }
        
        .userinfo-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 100%;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }
        
        .userinfo-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }
        
        .userinfo-title {
            text-align: center;
            font-size: 2rem;
            color: #ffffff;
            margin-bottom: 30px;
            font-weight: 300;
            letter-spacing: 1px;
            position: relative;
        }
        
        .userinfo-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.7), transparent);
            border-radius: 1px;
        }
        
        .userinfo-avatar {
            display: block;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .userinfo-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .avatar-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }
        
        .userinfo-avatar:hover .avatar-upload-overlay {
            opacity: 1;
        }
        
        .avatar-upload-text {
            color: white;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .avatar-upload-container {
            display: none;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }
        
        .avatar-upload-container.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .avatar-upload-btn {
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .avatar-upload-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .avatar-upload-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 10px;
            display: block;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .userinfo-details {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .userinfo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .userinfo-item.bio-item {
            align-items: flex-start;
            padding-bottom: 15px;
        }
        
        .userinfo-item.username-item {
            padding-bottom: 15px;
        }
        
        .edit-btn {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .edit-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .bio-edit-container {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            animation: fadeIn 0.3s ease;
        }
        
        .bio-input {
            width: 100%;
            min-height: 80px;
            padding: 10px 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .bio-input:focus {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .bio-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .char-counter {
            text-align: right;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }
        
        .bio-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .save-btn, .cancel-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .save-btn {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.8), rgba(76, 175, 80, 0.6));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .save-btn:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.9), rgba(76, 175, 80, 0.7));
            transform: translateY(-2px);
        }
        
        .cancel-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .cancel-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .username-edit-container {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            animation: fadeIn 0.3s ease;
        }
        
        .username-input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-family: inherit;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .username-input:focus {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .username-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .username-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .userinfo-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        
        .userinfo-label {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            display: flex;
            align-items: center;
        }
        
        .userinfo-value {
            color: #ffffff;
            font-size: 1rem;
            text-align: right;
            font-weight: 600;
        }
        
        .back-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 30px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.8), rgba(76, 175, 80, 0.6));
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .back-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .back-button:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.9), rgba(76, 175, 80, 0.7));
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
            .back-button:hover::before {
                left: 100%;
            }

        .level-progress-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            margin-left: 15px;
        }

        .level-progress-bar {
            height: 24px;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .level-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A, #AED581);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
            position: relative;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.4);
        }

        .level-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 2s infinite;
        }

        .level-progress-fill.level-up {
            animation: levelUpPulse 0.8s ease-out;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FF6347);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes levelUpPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        .level-progress-text {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.85);
            text-align: right;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .level-progress-info {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .level-up-badge {
            display: none;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
            animation: badgeAppear 0.5s ease-out;
        }

        .level-up-badge.show {
            display: inline-block;
        }

        @keyframes badgeAppear {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* éŸ³é‡æ§åˆ¶æ ·å¼ - ä¸æ¸¸æˆé¡µé¢ä¸€è‡´ */
        .volume-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, rgba(30, 30, 40, 0.85), rgba(20, 20, 30, 0.9));
            border-radius: 30px;
            padding: 8px 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }

        .volume-control:hover {
            background: linear-gradient(135deg, rgba(40, 40, 50, 0.95), rgba(30, 30, 40, 0.95));
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        .volume-icon {
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s ease;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .volume-icon:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: scale(1.1);
        }

        .volume-icon:active {
            transform: scale(0.95);
        }

        .volume-slider-container {
            display: flex;
            align-items: center;
            margin-left: 12px;
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .volume-control:hover .volume-slider-container {
            opacity: 1;
            max-width: 180px;
            margin-left: 12px;
        }

        .volume-slider {
            width: 120px;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #ff5252 0%, #ff5252 30%, #ffeb3b 30%, #ffeb3b 70%, #4caf50 70%, #4caf50 100%);
            outline: none;
            border-radius: 3px;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #fff;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #fff;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: none;
            transition: all 0.2s ease;
        }

        .volume-slider:hover::-webkit-slider-thumb {
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .volume-slider:hover::-moz-range-thumb {
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .volume-value {
            margin-left: 10px;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            min-width: 40px;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* æ·»åŠ éŸ³é‡é¢„è®¾æŒ‰é’® */
        .volume-presets {
            display: flex;
            margin-left: 10px;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .volume-control:hover .volume-presets {
            opacity: 1;
        }

        .volume-preset-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
        }

        .volume-preset-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .volume-preset-btn:active {
            transform: scale(0.95);
        }

        .volume-preset-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.15);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* ä¸ºé™éŸ³çŠ¶æ€æ·»åŠ ç‰¹æ®Šæ ·å¼ */
        .volume-control.muted .volume-icon {
            color: #ff5252;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .volume-control {
                top: 15px;
                right: 15px;
                padding: 6px 12px;
            }

            .volume-icon {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }

            .volume-slider {
                width: 90px;
            }

            .volume-value {
                font-size: 12px;
                min-width: 35px;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .userinfo-container {
                padding: 25px;
            }
            
            .userinfo-title {
                font-size: 1.5rem;
            }
            
            .userinfo-avatar {
                width: 100px;
                height: 100px;
            }
            
            .userinfo-item {
                padding: 10px 12px;
            }
        }
        
        @media (max-width: 480px) {
            .userinfo-container {
                padding: 20px;
            }
            
            .userinfo-title {
                font-size: 1.3rem;
            }
            
            .userinfo-avatar {
                width: 90px;
                height: 90px;
            }
            
            .userinfo-label, .userinfo-value {
                font-size: 0.9rem;
            }
            
            .back-button {
                padding: 12px;
                font-size: 0.9rem;
            }
        }
    </style>
    </head>
<body>
    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgMusic" loop>
        <source src="../assets/sounds/effects/mainMusic.mp3" type="audio/mpeg">
    </audio>
    
    <!-- éŸ³é‡æ§åˆ¶ -->
    <div class="volume-control" id="volumeControl">
        <div class="volume-icon" id="volumeIcon">ğŸ”Š</div>
        <div class="volume-slider-container" id="volumeSliderContainer">
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
            <div class="volume-value" id="volumeValue">70%</div>
            <div class="volume-presets">
                <button class="volume-preset-btn" data-volume="0">0</button>
                <button class="volume-preset-btn" data-volume="25">25</button>
                <button class="volume-preset-btn" data-volume="50">50</button>
                <button class="volume-preset-btn" data-volume="75">75</button>
                <button class="volume-preset-btn" data-volume="100">100</button>
            </div>
        </div>
    </div>
    
    <div class="userinfo-container">
        <h1 class="userinfo-title">ä¸ªäººä¿¡æ¯</h1>
        <div style="position: relative; display: inline-block;">
            <img src="../assets/images/avatar-default.svg" alt="ç”¨æˆ·å¤´åƒ" class="userinfo-avatar" id="user-avatar">
            <div class="avatar-upload-overlay" id="avatar-upload-overlay">
                <div class="avatar-upload-text">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</div>
            </div>
        </div>
        <div class="avatar-upload-container" id="avatar-upload-container">
            <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">
            <button class="avatar-upload-btn" id="avatar-upload-btn">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</button>
            <img src="" alt="å¤´åƒé¢„è§ˆ" class="avatar-preview" id="avatar-preview" style="display: none;">
            <div class="avatar-upload-actions" id="avatar-upload-actions" style="display: none;">
                <button class="save-btn" id="save-avatar-btn">ä¿å­˜å¤´åƒ</button>
                <button class="cancel-btn" id="cancel-avatar-btn">å–æ¶ˆ</button>
            </div>
        </div>
        <div class="userinfo-details">
            <div class="userinfo-item username-item">
                <span class="userinfo-label">ç”¨æˆ·å</span>
                <span class="userinfo-value" id="username-display">ç©å®¶ä¸€å·</span>
                <button class="edit-btn" id="edit-username-btn">ç¼–è¾‘</button>
            </div>
            <div class="username-edit-container" id="username-edit-container">
                <input type="text" class="username-input" id="username-input" maxlength="20" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆæœ€å¤š20ä¸ªå­—ç¬¦ï¼‰">
                <div class="username-actions">
                    <button class="save-btn" id="save-username-btn">ä¿å­˜</button>
                    <button class="cancel-btn" id="cancel-username-btn">å–æ¶ˆ</button>
                </div>
            </div>
            <div class="userinfo-item">
                <span class="userinfo-label">é‚®ç®±</span>
                <span class="userinfo-value" id="email-display">player@example.com</span>
            </div>
            <div class="userinfo-item">
                <span class="userinfo-label">ç­‰çº§</span>
                <span class="userinfo-value" id="level-display">Lv. 1</span>
            </div>
            <div class="userinfo-item">
                <span class="userinfo-label">æ¸¸æˆæ—¶é•¿</span>
                <span class="userinfo-value" id="playtime-display">0 å°æ—¶</span>
            </div>
            <div class="userinfo-item">
                <span class="userinfo-label">å‡çº§è¿›åº¦</span>
                <div class="level-progress-container">
                    <div class="level-progress-bar">
                        <div class="level-progress-fill" id="level-progress-fill"></div>
                    </div>
                    <div class="level-progress-text">
                        <span id="level-progress-text">0%</span>
                        <span id="level-progress-info" class="level-progress-info"></span>
                        <span id="level-up-badge" class="level-up-badge">å‡çº§!</span>
                    </div>
                </div>
            </div>
            <div class="userinfo-item bio-item">
                <span class="userinfo-label">ä¸ªäººä»‹ç»</span>
                <span class="userinfo-value" id="bio-display">çƒ­çˆ±æ¸¸æˆï¼Œäº«å—ç«æŠ€çš„ä¹è¶£</span>
                <button class="edit-btn" id="edit-bio-btn">ç¼–è¾‘</button>
            </div>
            <div class="bio-edit-container" id="bio-edit-container">
                <textarea class="bio-input" id="bio-input" maxlength="100" placeholder="è¯·è¾“å…¥ä¸ªäººä»‹ç»ï¼ˆæœ€å¤š100å­—ï¼‰">çƒ­çˆ±æ¸¸æˆï¼Œäº«å—ç«æŠ€çš„ä¹è¶£</textarea>
                <div class="char-counter">
                    <span id="char-count">18</span>/100
                </div>
                <div class="bio-actions">
                    <button class="save-btn" id="save-bio-btn">ä¿å­˜</button>
                    <button class="cancel-btn" id="cancel-bio-btn">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        <button class="back-button" onclick="event.preventDefault(); goBack()">è¿”å›æ¸¸æˆ</button>
    </div>

    <script>
        function goBack() {
            console.log('ä¸ªäººä¿¡æ¯é¡µé¢è¿”å›æŒ‰é’®è¢«ç‚¹å‡»ï¼Œè¿”å›åˆ°æ¸¸æˆä¸»èœå•');
            window.location.href = './game.html';  // è¿”å›åˆ°æ¸¸æˆä¸»èœå•é¡µé¢
        }
        
        // ä¸ªäººä¿¡æ¯ç¼–è¾‘åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // åŠ è½½ç”¨æˆ·ç­‰çº§ä¿¡æ¯
            loadUserLevelInfo();

            // ä¸ªäººä»‹ç»ç›¸å…³å…ƒç´ 
            const editBioBtn = document.getElementById('edit-bio-btn');
            const saveBioBtn = document.getElementById('save-bio-btn');
            const cancelBioBtn = document.getElementById('cancel-bio-btn');
            const bioDisplay = document.getElementById('bio-display');
            const bioEditContainer = document.getElementById('bio-edit-container');
            const bioInput = document.getElementById('bio-input');
            
            // ç”¨æˆ·åç›¸å…³å…ƒç´ 
            const editUsernameBtn = document.getElementById('edit-username-btn');
            const saveUsernameBtn = document.getElementById('save-username-btn');
            const cancelUsernameBtn = document.getElementById('cancel-username-btn');
            const usernameDisplay = document.getElementById('username-display');
            const usernameEditContainer = document.getElementById('username-edit-container');
            const usernameInput = document.getElementById('username-input');
            
            // ä»localStorageåŠ è½½ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯
            const savedUsername = localStorage.getItem('username');
            const savedBio = localStorage.getItem('userBio');
            const savedEmail = localStorage.getItem('userEmail');
            
            // åŠ è½½ç”¨æˆ·å
            if (savedUsername) {
                usernameDisplay.textContent = savedUsername;
                usernameInput.value = savedUsername;
            }
            
            // åŠ è½½é‚®ç®±
            if (savedEmail) {
                document.getElementById('email-display').textContent = savedEmail;
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é‚®ç®±ï¼Œå°è¯•ä»ç™»å½•ä¿¡æ¯è·å–
                const user = JSON.parse(localStorage.getItem('user'));
                if (user && user.email) {
                    document.getElementById('email-display').textContent = user.email;
                    localStorage.setItem('userEmail', user.email);
                }
            }
            
            // åŠ è½½ä¸ªäººä»‹ç»
            if (savedBio) {
                bioDisplay.textContent = savedBio;
                bioInput.value = savedBio;
            }
            
            // ä¸ªäººä»‹ç»ç¼–è¾‘åŠŸèƒ½
            editBioBtn.addEventListener('click', function(e) {
                bioEditContainer.style.display = 'flex';
                editBioBtn.style.display = 'none';
                bioInput.focus();
            });
            
            saveBioBtn.addEventListener('click', function(e) {
                const newBio = bioInput.value.trim();
                if (newBio) {
                    bioDisplay.textContent = newBio;
                    localStorage.setItem('userBio', newBio);
                    closeBioEditMode();
                }
            });
            
            cancelBioBtn.addEventListener('click', function(e) {
                bioInput.value = bioDisplay.textContent;
                closeBioEditMode();
            });
            
            // ç”¨æˆ·åç¼–è¾‘åŠŸèƒ½
            editUsernameBtn.addEventListener('click', function(e) {
                usernameEditContainer.style.display = 'flex';
                editUsernameBtn.style.display = 'none';
                usernameInput.focus();
                usernameInput.select();
            });
            
            saveUsernameBtn.addEventListener('click', function(e) {
                const newUsername = usernameInput.value.trim();
                if (newUsername) {
                    usernameDisplay.textContent = newUsername;
                    localStorage.setItem('username', newUsername);
                    closeUsernameEditMode();
                }
            });
            
            cancelUsernameBtn.addEventListener('click', function(e) {
                usernameInput.value = usernameDisplay.textContent;
                closeUsernameEditMode();
            });
            
            // å…³é—­ä¸ªäººä»‹ç»ç¼–è¾‘æ¨¡å¼
            function closeBioEditMode() {
                bioEditContainer.style.display = 'none';
                editBioBtn.style.display = 'block';
            }
            
            // å…³é—­ç”¨æˆ·åç¼–è¾‘æ¨¡å¼
            function closeUsernameEditMode() {
                usernameEditContainer.style.display = 'none';
                editUsernameBtn.style.display = 'block';
            }
            
            // å­—ç¬¦è®¡æ•°åŠŸèƒ½
            const charCount = document.getElementById('char-count');
            updateCharCount();
            
            bioInput.addEventListener('input', function() {
                updateCharCount();
            });
            
            function updateCharCount() {
                const currentLength = bioInput.value.length;
                charCount.textContent = currentLength;
                
                // å½“æ¥è¿‘å­—æ•°é™åˆ¶æ—¶æ”¹å˜é¢œè‰²
                if (currentLength > 90) {
                    charCount.style.color = 'rgba(255, 100, 100, 0.9)';
                } else {
                    charCount.style.color = 'rgba(255, 255, 255, 0.6)';
                }
            }
            
            // æ·»åŠ å›è½¦é”®ä¿å­˜åŠŸèƒ½
            usernameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveUsernameBtn.click();
                }
            });
            
            bioInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // é˜²æ­¢æ¢è¡Œ
                    saveBioBtn.click();
                }
            });
        });

        // åŠ è½½ç”¨æˆ·ç­‰çº§ä¿¡æ¯
        let previousLevel = 0;
        let previousProgress = 0;
        let autoUpdateInterval = null;

        async function loadUserLevelInfo() {
            try {
                console.log('å¼€å§‹åŠ è½½ç”¨æˆ·ç­‰çº§ä¿¡æ¯...');

                // ç­‰å¾…Supabaseåˆå§‹åŒ–å®Œæˆ
                if (window.userDataManagerReady) {
                    await window.userDataManagerReady;
                }

                // ç­‰å¾…userDataManagerå¯ç”¨
                let retryCount = 0;
                while (!window.userDataManager && retryCount < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retryCount++;
                }

                if (!window.userDataManager || !window.userDataManager.currentUser) {
                    console.log('ç”¨æˆ·æœªç™»å½•ï¼Œä½¿ç”¨é»˜è®¤ç­‰çº§');
                    updateLevelDisplay({
                        currentLevel: 1,
                        totalHours: 0,
                        progress: 0,
                        minutesToNextLevel: 300,
                        currentLevelRequiredMinutes: 0
                    });
                    return;
                }

                // è·å–ç”¨æˆ·ç­‰çº§ä¿¡æ¯
                const levelInfo = await window.userDataManager.getUserLevelInfo();

                if (levelInfo) {
                    console.log('è·å–åˆ°ç­‰çº§ä¿¡æ¯:', levelInfo);
                    updateLevelDisplay(levelInfo);

                    // å¯åŠ¨è‡ªåŠ¨æ›´æ–°ï¼ˆæ¯30ç§’ï¼‰
                    startAutoUpdate();
                } else {
                    console.log('è·å–ç­‰çº§ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                    updateLevelDisplay({
                        currentLevel: 1,
                        totalHours: 0,
                        progress: 0,
                        minutesToNextLevel: 300,
                        currentLevelRequiredMinutes: 0
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ç­‰çº§ä¿¡æ¯å¤±è´¥:', error);
                updateLevelDisplay({
                    currentLevel: 1,
                    totalHours: 0,
                    progress: 0,
                    minutesToNextLevel: 300,
                    currentLevelRequiredMinutes: 0
                });
            }
        }

        // å¯åŠ¨è‡ªåŠ¨æ›´æ–°
        function startAutoUpdate() {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
            }

            autoUpdateInterval = setInterval(async () => {
                if (!window.userDataManager || !window.userDataManager.currentUser) {
                    clearInterval(autoUpdateInterval);
                    autoUpdateInterval = null;
                    return;
                }

                try {
                    const levelInfo = await window.userDataManager.getUserLevelInfo();
                    if (levelInfo) {
                        updateLevelDisplay(levelInfo);
                    }
                } catch (error) {
                    console.error('è‡ªåŠ¨æ›´æ–°ç­‰çº§ä¿¡æ¯å¤±è´¥:', error);
                }
            }, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡

            console.log('å·²å¯åŠ¨ç­‰çº§ä¿¡æ¯è‡ªåŠ¨æ›´æ–°');
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            if (hours > 0) {
                return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
            }
            return `${mins}åˆ†é’Ÿ`;
        }

        // æ›´æ–°ç­‰çº§æ˜¾ç¤º
        function updateLevelDisplay(levelInfo) {
            const currentLevel = parseInt(levelInfo.currentLevel) || 1;
            const progress = Math.min(100, Math.max(0, parseFloat(levelInfo.progress) || 0));
            const minutesToNext = parseFloat(levelInfo.minutesToNextLevel) || 300;
            const currentRequired = parseFloat(levelInfo.currentLevelRequiredMinutes) || 0;
            const totalMinutes = parseFloat(levelInfo.totalMinutes) || 0;

            // æ›´æ–°ç­‰çº§
            document.getElementById('level-display').textContent = `Lv. ${currentLevel}`;

            // æ›´æ–°æ¸¸æˆæ—¶é•¿
            document.getElementById('playtime-display').textContent = `${levelInfo.totalHours} å°æ—¶`;

            // æ›´æ–°å‡çº§è¿›åº¦æ¡
            const progressFill = document.getElementById('level-progress-fill');
            progressFill.style.width = `${progress}%`;

            // æ£€æµ‹æ˜¯å¦å‡çº§
            if (currentLevel > previousLevel && previousLevel > 0) {
                // æ˜¾ç¤ºå‡çº§æ•ˆæœ
                progressFill.classList.add('level-up');
                const badge = document.getElementById('level-up-badge');
                badge.classList.add('show');

                // 3ç§’åç§»é™¤å‡çº§æ•ˆæœ
                setTimeout(() => {
                    progressFill.classList.remove('level-up');
                    badge.classList.remove('show');
                }, 3000);

                console.log(`å‡çº§äº†ï¼ä» ${previousLevel} å‡çº§åˆ° ${currentLevel}`);
            }

            // æ›´æ–°è¿›åº¦æ–‡æœ¬
            const progressText = document.getElementById('level-progress-text');
            progressText.textContent = `${progress.toFixed(1)}%`;

            // æ›´æ–°è¿›åº¦ä¿¡æ¯
            const progressInfo = document.getElementById('level-progress-info');
            const playedAtCurrentLevel = totalMinutes - currentRequired;
            const remainingMinutes = minutesToNext - playedAtCurrentLevel;

            if (remainingMinutes > 0) {
                progressInfo.textContent = `è¿˜éœ€ ${formatDuration(remainingMinutes)} å‡çº§`;
            } else {
                progressInfo.textContent = `å³å°†å‡çº§!`;
            }

            // ä¿å­˜å½“å‰çŠ¶æ€
            previousLevel = currentLevel;
            previousProgress = progress;

            console.log('ç­‰çº§æ˜¾ç¤ºå·²æ›´æ–°:', levelInfo);
        }
        
        // å¤´åƒä¸Šä¼ åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const avatar = document.getElementById('user-avatar');
            const avatarUploadOverlay = document.getElementById('avatar-upload-overlay');
            const avatarUploadContainer = document.getElementById('avatar-upload-container');
            const avatarFileInput = document.getElementById('avatar-file-input');
            const avatarUploadBtn = document.getElementById('avatar-upload-btn');
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarUploadActions = document.getElementById('avatar-upload-actions');
            const saveAvatarBtn = document.getElementById('save-avatar-btn');
            const cancelAvatarBtn = document.getElementById('cancel-avatar-btn');
            
            // åŠ è½½ç”¨æˆ·å¤´åƒ
            loadUserAvatar();
            
            // ç‚¹å‡»å¤´åƒæˆ–è¦†ç›–å±‚è§¦å‘ä¸Šä¼ 
            avatar.addEventListener('click', function(e) {
                avatarFileInput.click();
            });
            
            avatarUploadOverlay.addEventListener('click', function(e) {
                avatarFileInput.click();
            });
            
            avatarUploadBtn.addEventListener('click', function(e) {
                avatarFileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            avatarFileInput.addEventListener('change', function(e) {
                console.log('æ–‡ä»¶é€‰æ‹©äº‹ä»¶è§¦å‘');
                const file = e.target.files[0];
                if (file) {
                    console.log('é€‰æ‹©äº†æ–‡ä»¶:', file.name, 'ç±»å‹:', file.type, 'å¤§å°:', file.size);
                    
                    // éªŒè¯æ–‡ä»¶ç±»å‹
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                    if (!allowedTypes.includes(file.type)) {
                        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼æ”¯æŒ JPGã€PNGã€GIF å’Œ WebP æ ¼å¼');
                        avatarFileInput.value = '';
                        return;
                    }
                    
                    // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º2MBï¼‰
                    if (file.size > 2 * 1024 * 1024) {
                        alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MBï¼');
                        avatarFileInput.value = '';
                        return;
                    }
                    
                    // æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸå’Œé¢„è§ˆ
                    avatarUploadContainer.classList.add('active');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œæ˜¾ç¤ºé¢„è§ˆ');
                        avatarPreview.src = e.target.result;
                        avatarPreview.style.display = 'block';
                        avatarUploadActions.style.display = 'flex';
                    };
                    reader.onerror = function() {
                        console.error('æ–‡ä»¶è¯»å–å¤±è´¥');
                        alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼');
                        resetAvatarUpload();
                    };
                    reader.readAsDataURL(file);
                } else {
                    console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                    resetAvatarUpload();
                }
            });
            
            // ä¿å­˜å¤´åƒ
            saveAvatarBtn.addEventListener('click', async function(e) {
                const file = avatarFileInput.files[0];
                if (!file) {
                    alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                    return;
                }
                
                console.log('å¼€å§‹ä¸Šä¼ å¤´åƒï¼Œæ–‡ä»¶:', file.name, 'å¤§å°:', file.size);
                
                try {
                    // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
                    saveAvatarBtn.disabled = true;
                    saveAvatarBtn.textContent = 'ä¸Šä¼ ä¸­...';
                    cancelAvatarBtn.disabled = true;
                    
                    // ç­‰å¾…Supabaseåˆå§‹åŒ–å®Œæˆ
                    console.log('æ£€æŸ¥Supabaseåˆå§‹åŒ–çŠ¶æ€...');
                    if (window.userDataManagerReady) {
                        console.log('ç­‰å¾…userDataManagerReadyå®Œæˆ...');
                        await window.userDataManagerReady;
                        console.log('userDataManagerReadyå·²å®Œæˆ');
                    }
                    
                    // ç­‰å¾…userDataManagerå¯ç”¨
                    console.log('æ£€æŸ¥userDataManageræ˜¯å¦å¯ç”¨...');
                    let retryCount = 0;
                    while (!window.userDataManager && retryCount < 50) {
                        console.log(`ç­‰å¾…userDataManagerå¯ç”¨... (${retryCount}/50)`);
                        await new Promise(resolve => setTimeout(resolve, 100));
                        retryCount++;
                    }
                    
                    if (!window.userDataManager) {
                        throw new Error('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                    
                    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
                    if (!window.userDataManager.currentUser) {
                        throw new Error('è¯·å…ˆç™»å½•åå†ä¸Šä¼ å¤´åƒ');
                    }
                    
                    // ä¸Šä¼ å¤´åƒåˆ°Supabaseå­˜å‚¨
                    console.log('ä½¿ç”¨Supabaseä¸Šä¼ å¤´åƒ');
                    const result = await window.userDataManager.uploadAvatar(file);
                    console.log('ä¸Šä¼ ç»“æœ:', result);
                    
                    if (result && result.success) {
                        // æ›´æ–°å¤´åƒæ˜¾ç¤º
                        avatar.src = result.url;
                        
                        // é‡ç½®ä¸Šä¼ è¡¨å•
                        resetAvatarUpload();
                        
                        // ä¿å­˜åˆ°localStorageä½œä¸ºç¼“å­˜
                        localStorage.setItem('userAvatar', result.url);
                        
                        // æ›´æ–°æ’è¡Œæ¦œå¤´åƒæ˜¾ç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        const leaderboardAvatar = document.querySelector(`[data-user-avatar="${window.userDataManager.currentUser.id}"]`);
                        if (leaderboardAvatar) {
                            leaderboardAvatar.src = result.url;
                        }
                        
                        alert('å¤´åƒä¸Šä¼ æˆåŠŸï¼');
                    } else {
                        const errorMsg = result?.error || 'æœªçŸ¥é”™è¯¯';
                        console.error('å¤´åƒä¸Šä¼ å¤±è´¥:', errorMsg);
                        alert('å¤´åƒä¸Šä¼ å¤±è´¥ï¼š' + errorMsg);
                    }
                } catch (error) {
                    console.error('å¤´åƒä¸Šä¼ é”™è¯¯:', error);
                    alert('å¤´åƒä¸Šä¼ å¤±è´¥ï¼š' + (error.message || 'è¯·é‡è¯•'));
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    saveAvatarBtn.disabled = false;
                    saveAvatarBtn.textContent = 'ä¿å­˜å¤´åƒ';
                    cancelAvatarBtn.disabled = false;
                }
            });
            
            // å–æ¶ˆä¸Šä¼ 
            cancelAvatarBtn.addEventListener('click', function(e) {
                resetAvatarUpload();
            });
            
            // åŠ è½½ç”¨æˆ·å¤´åƒ
            async function loadUserAvatar() {
                try {
                    // ç­‰å¾…Supabaseè„šæœ¬åŠ è½½å®Œæˆ
                    let retryCount = 0;
                    while (!window.userDataManager && retryCount < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        retryCount++;
                    }
                    
                    // å¦‚æœSupabaseç”¨æˆ·ç®¡ç†å™¨å­˜åœ¨ï¼Œå…ˆç­‰å¾…å…¶åˆå§‹åŒ–å®Œæˆï¼Œç¡®ä¿ä¼šè¯å¯ç”¨
                    if (window.userDataManagerReady) {
                        try {
                            await window.userDataManagerReady;
                            console.log('Supabaseåˆå§‹åŒ–å®Œæˆï¼Œç”¨æˆ·:', window.userDataManager?.currentUser?.email || 'æœªç™»å½•');
                        } catch (e) {
                            console.warn('ç”¨æˆ·æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¤´åƒæˆ–é»˜è®¤å¤´åƒ:', e);
                        }
                    } else if (window.userDataManager) {
                        // å¦‚æœuserDataManagerReadyä¸å­˜åœ¨ï¼Œä½†userDataManagerå­˜åœ¨ï¼Œå°è¯•æ‰‹åŠ¨åˆå§‹åŒ–
                        if (!window.userDataManager.initialized) {
                            await window.userDataManager.initialize();
                        }
                    }
                
                    // å…ˆä»localStorageè·å–ç¼“å­˜çš„å¤´åƒ
                    const cachedAvatar = localStorage.getItem('userAvatar');
                    if (cachedAvatar) {
                        avatar.src = cachedAvatar;
                        return;
                    }
                    
                    // å¦‚æœSupabaseå¯ç”¨ï¼Œä»æ•°æ®åº“è·å–
                    if (window.userDataManager) {
                        const profile = await window.userDataManager.getUserProfile();
                        if (profile && profile.avatar_url) {
                            avatar.src = profile.avatar_url;
                            localStorage.setItem('userAvatar', profile.avatar_url);
                            return;
                        }
                    }
                    
                    // ä½¿ç”¨é»˜è®¤å¤´åƒ
                    avatar.src = '../assets/images/avatar-default.svg';
                } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·å¤´åƒå¤±è´¥:', error);
            avatar.src = '../assets/images/avatar-default.svg';
                }
            }
            
            // é‡ç½®ä¸Šä¼ è¡¨å•
            function resetAvatarUpload() {
                avatarFileInput.value = '';
                avatarPreview.style.display = 'none';
                avatarUploadActions.style.display = 'none';
                avatarUploadContainer.classList.remove('active');
                avatarPreview.src = '';
                saveAvatarBtn.disabled = false;
                saveAvatarBtn.textContent = 'ä¿å­˜å¤´åƒ';
                cancelAvatarBtn.disabled = false;
            }
        });
        
        // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
        document.addEventListener('DOMContentLoaded', function() {
            const bgMusic = document.getElementById('bgMusic');
            const volumeIcon = document.getElementById('volumeIcon');
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeValue = document.getElementById('volumeValue');
            const volumeControl = document.getElementById('volumeControl');
            const volumePresets = document.querySelectorAll('.volume-preset-btn');
            
            // ä»localStorageè¯»å–éŸ³é‡çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼70%
            let currentVolume = parseInt(localStorage.getItem('bgmVolume')) || 70;
            let savedVolume = parseInt(localStorage.getItem('bgmSavedVolume')) || 70;
            let isMusicPlaying = false;
            
            // è®¾ç½®åˆå§‹éŸ³é‡å’ŒUI
            bgMusic.volume = currentVolume / 100;
            volumeSlider.value = currentVolume;
            volumeValue.textContent = currentVolume + "%";
            updateVolumeIcon();
            updateSliderBackground();
            
            // æ£€æŸ¥å¹¶ä¿å­˜éŸ³é¢‘çŠ¶æ€åˆ°localStorage
            function saveAudioState() {
                localStorage.setItem('bgmVolume', currentVolume);
                localStorage.setItem('bgmSavedVolume', savedVolume);
                localStorage.setItem('bgmIsPlaying', !bgMusic.paused);
                if (!bgMusic.paused) {
                    localStorage.setItem('bgmCurrentTime', bgMusic.currentTime);
                }
            }
            
            // ä»localStorageæ¢å¤éŸ³é¢‘çŠ¶æ€
            function restoreAudioState() {
                const savedIsPlaying = localStorage.getItem('bgmIsPlaying');
                const savedCurrentTime = localStorage.getItem('bgmCurrentTime');
                
                if (savedIsPlaying === 'true' && savedCurrentTime) {
                    bgMusic.currentTime = parseFloat(savedCurrentTime);
                    bgMusic.play().then(() => {
                        isMusicPlaying = true;
                        console.log('èƒŒæ™¯éŸ³ä¹ä»ä¸Šæ¬¡ä½ç½®ç»§ç»­æ’­æ”¾');
                    }).catch(error => {
                        console.log('èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:', error);
                    });
                }
            }
            
            // é¡µé¢å¸è½½æ—¶ä¿å­˜çŠ¶æ€
            window.addEventListener('beforeunload', saveAudioState);

            // é¡µé¢å¸è½½æ—¶æ¸…é™¤è‡ªåŠ¨æ›´æ–°
            window.addEventListener('beforeunload', () => {
                if (autoUpdateInterval) {
                    clearInterval(autoUpdateInterval);
                }
            });

            // é¡µé¢åŠ è½½æ—¶æ¢å¤çŠ¶æ€
            restoreAudioState();
            
            // ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®å¼€å§‹æ’­æ”¾éŸ³ä¹ï¼ˆè§£å†³æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
            document.addEventListener('click', function initMusic() {
                if (!isMusicPlaying) {
                    bgMusic.play().then(() => {
                        isMusicPlaying = true;
                        console.log('èƒŒæ™¯éŸ³ä¹å¼€å§‹æ’­æ”¾');
                    }).catch(error => {
                        console.log('èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:', error);
                    });
                    
                    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                    document.removeEventListener('click', initMusic);
                }
            }, { once: true });
            
            // éŸ³é‡å›¾æ ‡ç‚¹å‡»äº‹ä»¶
            volumeIcon.addEventListener('click', function() {
                if (currentVolume > 0) {
                    // ä¿å­˜å½“å‰éŸ³é‡å¹¶é™éŸ³
                    savedVolume = currentVolume;
                    currentVolume = 0;
                    volumeSlider.value = 0;
                    volumeValue.textContent = "0%";
                    updateVolumeIcon("ğŸ”‡");
                    volumeControl.classList.add("muted");
                } else {
                    // æ¢å¤ä¹‹å‰çš„éŸ³é‡
                    currentVolume = savedVolume || 70;
                    volumeSlider.value = currentVolume;
                    volumeValue.textContent = currentVolume + "%";
                    updateVolumeIcon();
                    volumeControl.classList.remove("muted");
                }
                bgMusic.volume = currentVolume / 100;
                saveAudioState();
            });
            
            // éŸ³é‡æ»‘å—å˜åŒ–äº‹ä»¶
            volumeSlider.addEventListener('input', function() {
                currentVolume = parseInt(this.value);
                volumeValue.textContent = currentVolume + "%";
                bgMusic.volume = currentVolume / 100;
                updateVolumeIcon();
                
                // å¦‚æœç”¨æˆ·ä»é™éŸ³çŠ¶æ€è°ƒæ•´éŸ³é‡ï¼Œè‡ªåŠ¨å–æ¶ˆé™éŸ³
                if (currentVolume > 0 && volumeControl.classList.contains("muted")) {
                    volumeControl.classList.remove("muted");
                }
                
                // ä¿å­˜çŠ¶æ€å¹¶æ›´æ–°æ»‘å—èƒŒæ™¯
                saveAudioState();
                updateSliderBackground();
            });
            
            // éŸ³é‡é¢„è®¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            volumePresets.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const presetVolume = parseInt(this.dataset.volume);
                    currentVolume = presetVolume;
                    volumeSlider.value = currentVolume;
                    volumeValue.textContent = currentVolume + "%";
                    updateVolumeIcon();
                    bgMusic.volume = currentVolume / 100;
                    
                    // å¦‚æœè®¾ç½®äº†éŸ³é‡ï¼Œå–æ¶ˆé™éŸ³çŠ¶æ€
                    if (currentVolume > 0 && volumeControl.classList.contains("muted")) {
                        volumeControl.classList.remove("muted");
                    }
                    
                    // ä¿å­˜çŠ¶æ€
                    savedVolume = currentVolume;
                    saveAudioState();
                    
                    // æ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”»
                    this.classList.add("active");
                    setTimeout(() => {
                        this.classList.remove("active");
                    }, 200);
                });
            });
            
            // æ›´æ–°éŸ³é‡å›¾æ ‡
            function updateVolumeIcon(customIcon) {
                if (customIcon) {
                    volumeIcon.textContent = customIcon;
                    return;
                }
                
                if (currentVolume == 0) {
                    volumeIcon.textContent = "ğŸ”‡";
                } else if (currentVolume < 30) {
                    volumeIcon.textContent = "ğŸ”ˆ";
                } else if (currentVolume < 70) {
                    volumeIcon.textContent = "ğŸ”‰";
                } else {
                    volumeIcon.textContent = "ğŸ”Š";
                }
                
                // æ›´æ–°æ»‘å—çš„èƒŒæ™¯æ¸å˜ï¼Œåæ˜ å½“å‰éŸ³é‡ä½ç½®
                updateSliderBackground();
            }
            
            // æ›´æ–°æ»‘å—èƒŒæ™¯æ¸å˜
            function updateSliderBackground() {
                const percentage = currentVolume;
                const color1 = percentage < 30 ? '#ff5252' : percentage < 70 ? '#ffeb3b' : '#4caf50';
                const color2 = percentage < 30 ? '#ffeb3b' : percentage < 70 ? '#4caf50' : '#2e7d32';
                volumeSlider.style.background = `linear-gradient(to right, ${color1} 0%, ${color1} ${percentage}%, rgba(255,255,255,0.2) ${percentage}%, rgba(255,255,255,0.2) 100%)`;
            }
            
            // åˆå§‹åŒ–æ»‘å—èƒŒæ™¯
            updateSliderBackground();
        });
    </script>
</body>
</html>