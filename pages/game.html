<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>åŒé”‹å¯¹å†³</title>
        <link rel = "stylesheet" href = "../styles/new.css"/>
        <link rel = "icon" href = "../favicon.ico" type = "image/x-icon" />
        <script src="../scripts/jquery.min.js"></script>

        <script>
            // æ£€æŸ¥jQueryæ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof $ !== 'undefined') {
                console.log('jQuery is loaded successfully');
            } else {
                console.error('jQuery is not loaded');
            }
        </script>
        <!-- Supabaseå®¢æˆ·ç«¯åº“ -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
        <!-- Supabaseæ•°æ®åº“è¿æ¥ -->
        <script src="../scripts/supabase.js"></script>
        <!-- æ¸¸æˆæ—¶é•¿è¿½è¸ªå™¨ -->
        <script src="../scripts/playtime-tracker.js"></script>
        <!-- æ¸¸æˆæ•°æ®ç®¡ç†å™¨ -->
        <script src="../scripts/game-data-manager.js"></script>
        <!-- æ¸¸æˆæ•°æ®é›†æˆ -->
        <script src="../scripts/game-integration.js"></script>
    </head>
    <body>
        <div class="game-container">
        <div class = "map">
            <div id="artBox">
                <div id="leftHouse"></div>
                <div id="rightHouse"></div>
                <div id="rightHousePlatform"></div>
                <div id="back"></div>
            </div>
            <div class = "man one"></div>
            <div class = "man two"></div>
            <div class = "line oo"></div>
            <div class = "line tt"></div>
            <div class = "meteor"></div>
            <div class = "shielding"></div>
            <div class = "ground bottom"></div>
            <div class = "ground left"></div>
            <div class = "ground right"></div>
            <div class = "sign Ma"></div>
            <div class = "sign Me"></div>
            <div id="bulletBox"></div>
            <div id="speedTip"></div>
            <div id="bloodBox">
                <div></div>
            </div>
            <div class = "medical kit"></div>
            <div class = "medical bottle"></div>
            <div id="aiBox"></div>
            <div id="fireBox"></div>
            <div class = "gg">
                <p class = "winner"></p>
                <video id="mageWinVideo" class="win-video" autoplay loop muted>
                    <source src="../assets/images/mageVictory.mp4" type="video/mp4">
                </video>
                <video id="mechanicianWinVideo" class="win-video" autoplay loop muted>
                    <source src="../assets/images/mechanician.mp4" type="video/mp4">
                </video>
            </div>
            <div class = "start">Round 1</div>
        <div class = "round-info">
            <span class="round-number">ç¬¬ 1/3 å›åˆ</span> | 
            <span class="map-name">è¯·é€‰æ‹©åœ°å›¾</span>
        </div>
        </div>
        
        <div class = "health B1">
            <div class = "H1 h10"></div>
            <div class = "H1 shield"></div>
            <div class = "H1 h11"></div>
        </div>
        <div class = "health B2">
            <div class = "H2 h20"></div>
            <div class = "H2 h21"></div>
        </div>

        <div class = "energy Mag">
            <div class = "En1 enLine"></div>
        </div>
        <div class = "energy Mech">
            <div class = "En2 enLine"></div>
        </div>
        
        <!-- æ³•å¸ˆæŠ€èƒ½æ˜¾ç¤ºåŒºåŸŸï¼ˆå›¾æ ‡ + ç¯å½¢è¿›åº¦æ¡ + å€’è®¡æ—¶ï¼‰ -->
        <div class="skills-panel mage-skills">
            <!-- X - æ³•åŠ›å‡èš -->
            <div class="skill-cooldown" data-skill="mana">
                <div class="skill-icon"></div>
                <div class="cooldown-ring"></div>
                <span class="countdown-text"></span>
                <div class="skill-key">X</div>
            </div>
            <!-- B - é­”ç„°å°„çº¿ -->
            <div class="skill-cooldown" data-skill="fire">
                <div class="skill-icon"></div>
                <div class="cooldown-ring"></div>
                <span class="countdown-text"></span>
                <div class="skill-key">B</div>
            </div>
            <!-- C - é­”éšœ -->
            <div class="skill-cooldown" data-skill="shield">
                <div class="skill-icon"></div>
                <div class="cooldown-ring"></div>
                <span class="countdown-text"></span>
                <div class="skill-key">C</div>
            </div>
            <!-- V - ç‚çˆ†æœ¯ -->
            <div class="skill-cooldown" data-skill="meteor">
                <div class="skill-icon"></div>
                <div class="cooldown-ring"></div>
                <span class="countdown-text"></span>
                <div class="skill-key">V</div>
            </div>
            <!-- Q - æ›¿èº«(å¤§æ‹›) -->
            <div class="skill-cooldown ultimate" data-skill="servant">
                <div class="skill-icon"></div>
                <div class="cooldown-ring"></div>
                <span class="countdown-text">æœªå°±ç»ª</span>
                <div class="skill-key">Q</div>
            </div>
        </div>
        
        <!-- æœºæ¢°å¸ˆæŠ€èƒ½æ˜¾ç¤ºåŒºåŸŸï¼ˆå›¾æ ‡ + ç¯å½¢è¿›åº¦æ¡ + å€’è®¡æ—¶ï¼‰ -->
        <div class="skills-panel mech-skills">
            <!-- M - è¡€ç¥­ -->
            <div class="skill-cooldown" data-skill="blood">
                <div class="skill-icon"></div>
                <div class="cooldown-ring"></div>
                <span class="countdown-text"></span>
                <div class="skill-key">M</div>
            </div>
            <!-- / - å°„å‡» -->
            <div class="skill-cooldown" data-skill="shoot">
                <div class="skill-icon"></div>
                <div class="cooldown-ring"></div>
                <span class="countdown-text"></span>
                <div class="skill-key">/</div>
            </div>
            <!-- , - çªè¿› -->
            <div class="skill-cooldown" data-skill="dash">
                <div class="skill-icon"></div>
                <div class="cooldown-ring"></div>
                <span class="countdown-text"></span>
                <div class="skill-key">,</div>
            </div>
            <!-- . - å¾®å‹æ ¸å¼¹ -->
            <div class="skill-cooldown" data-skill="nuke">
                <div class="skill-icon"></div>
                <div class="cooldown-ring"></div>
                <span class="countdown-text"></span>
                <div class="skill-key">.</div>
            </div>
            <!-- L - ææ€–æœºå™¨äºº(å¤§æ‹›) -->
            <div class="skill-cooldown ultimate" data-skill="machine">
                <div class="skill-icon"></div>
                <div class="cooldown-ring"></div>
                <span class="countdown-text">æœªå°±ç»ª</span>
                <div class="skill-key">L</div>
            </div>
        </div>
        <div id = "sound">
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/fireAtk.mp3" type="audio/mpeg" /><!--0-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/fireboom.mp3" type="audio/mpeg" /><!--1-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/mage.ah1.mp3" type="audio/mpeg" /><!--2-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/mage.ah2.mp3" type="audio/mpeg" /><!--3-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/mage.ah3.mp3" type="audio/mpeg" /><!--4-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/mageDie.mp3" type="audio/mpeg" /><!--5-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/mageWin.mp3" type="audio/mpeg" /><!--6-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/servant.die.mp3" type="audio/mpeg" /><!--7-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/servant.say.mp3" type="audio/mpeg" /><!--8-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/yes.my.mp3" type="audio/mpeg" /><!--9-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/tinyfire.mp3" type="audio/mpeg" /><!--10-->
            </audio>
            <audio class = "MageAudio">
                <source src="../assets/sounds/characters/mage/stop.mp3" type="audio/mpeg" /><!--11-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/boom.mp3" type="audio/mpeg" /><!--0-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/crazy.mp3" type="audio/mpeg" /><!--1-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/drone.mp3" type="audio/mpeg" /><!--2-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/droneboom.mp3" type="audio/mpeg" /><!--3-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/flash.mp3" type="audio/mpeg" /><!--4-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/grenade.mp3" type="audio/mpeg" /><!--5-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/mechDie.mp3" type="audio/mpeg" /><!--6-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/mechhurt1.mp3" type="audio/mpeg" /><!--7-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/mechhurt2.mp3" type="audio/mpeg" /><!--8-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/mechhurt3.mp3" type="audio/mpeg" /><!--9-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/mechWin.mp3" type="audio/mpeg" /><!--10-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/reload.mp3" type="audio/mpeg" /><!--11-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/reloadFast.mp3" type="audio/mpeg" /><!--12-->
            </audio>
            <audio class = "MechAudio">
                <source src="../assets/sounds/characters/mech/walk.mp3" type="audio/mpeg" /><!--13-->
            </audio>
            <audio class = "healAudio">
                <source src="../assets/sounds/effects/heal.mp3" type="audio/mpeg" />
            </audio>
            <audio class = "roundAudio">
                <source src="../assets/sounds/effects/round1.mp3" type="audio/mpeg" />
            </audio>
            <audio class = "roundAudio">
                <source src="../assets/sounds/effects/round2.mp3" type="audio/mpeg" />
            </audio>
            <audio class = "roundAudio">
                <source src="../assets/sounds/effects/round3.mp3" type="audio/mpeg" />
            </audio>
            <audio class = "roundAudio">
                <source src="../assets/sounds/effects/fight.mp3" type="audio/mpeg" />
             </audio>
            <audio class = "roundAudio">
                <source src="../assets/sounds/effects/fight.mp3" type="audio/mpeg" />
              </audio>
            <audio class = "roundAudio">
                <source src="../assets/sounds/effects/fight.mp3" type="audio/mpeg" />
               </audio>
            <audio class = "roundAudio">
                <source src="../assets/sounds/effects/fight.mp3" type="audio/mpeg" />
               </audio>
            <audio class = "BGM" loop>
                <source src="../assets/sounds/bgm/BGM1.mp3" type="audio/mpeg" />
              </audio>
            <audio class = "BGM" loop>
                <source src="../assets/sounds/bgm/BGM6.mp3" type="audio/mpeg" />
               </audio>
            <audio class = "BGM" loop>
                <source src="../assets/sounds/bgm/BGM2.mp3" type="audio/mpeg" />
               </audio>
            <audio class = "BGM" loop>
                <source src="../assets/sounds/bgm/BGM3.mp3" type="audio/mpeg" />
                </audio>
            <audio class = "BGM" loop>
                <source src="../assets/sounds/bgm/BGM4.mp3" type="audio/mpeg" />
                </audio>
            <audio class = "BGM" loop>
                <source src="../assets/sounds/bgm/BGM5.mp3" type="audio/mpeg" />
                </audio>
            <!-- ä¸»é¡µé¢èƒŒæ™¯éŸ³é¢‘ -->
            <audio id="mainMenuBGM" loop preload="auto">
                <source src="../assets/sounds/effects/mainMusic.mp3" type="audio/mpeg" />
             </audio>
        </div>

        
        

        
        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <div class="game-main-menu" id="gameMainMenu">

            <!-- åŠ¨æ€èƒŒæ™¯è§†é¢‘ -->
            <video id="backgroundVideo" autoplay muted loop>
                <source src="../assets/images/mainImage.mp4" type="video/mp4">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
            </video>
            <div class="main-menu-content">
                <div class="main-menu-header">
                    <img src="../assets/images/logo.png" alt="åŒé”‹å¯¹å†³" class="game-logo">
                    <p>ä¸‰å±€ä¸¤èƒœåˆ¶å¯¹å†³</p>
                </div>
                <div class="main-menu-body">
                    <button class="main-menu-button primary" id="mapSelectionBtn">é€‰æ‹©åœ°å›¾</button>
                    <button class="main-menu-button secondary" id="leaderboardBtn">æ’è¡Œæ¦œ</button>
                    <button class="main-menu-button secondary" id="userInfoBtn">ä¸ªäººä¿¡æ¯</button>
                    <button class="main-menu-button secondary" id="helpBtnFromMain">æ¸¸æˆå¸®åŠ©</button>
                    <button class="main-menu-button secondary" id="backToLoginBtn">è¿”å›ç™»å½•</button>
                </div>
            </div>
        </div>
        
        <div class = "map-selection" id="mapSelection">
            <div class="map-selection-content">
                <div class="map-selection-header">
                    <h2>é€‰æ‹©åœ°å›¾</h2>
                    <p>é€‰æ‹©ä¸€ä¸ªåœ°å›¾è¿›è¡Œä¸‰å±€ä¸¤èƒœçš„å¯¹å†³</p>
                </div>
                <div class="map-selection-body">
                    <div class="map-grid">
                        <div class="map-item" data-map="0">
                            <div class="map-preview" style="background-image: url(../assets/images/backgrounds/background1.png)"></div>
                            <div class="map-name">åŸé•‡å¹¿åœº</div>
                        </div>
                        <div class="map-item" data-map="1">
                            <div class="map-preview" style="background-image: url(../assets/images/backgrounds/background2.png)"></div>
                            <div class="map-name">å³­å£ä¹‹æˆ˜</div>
                        </div>
                        <div class="map-item" data-map="2">
                            <div class="map-preview" style="background-image: url(../assets/images/backgrounds/background3.png)"></div>
                            <div class="map-name">åœ°ä¸‹çŸ¿äº•</div>
                        </div>
                        <div class="map-item" data-map="3">
                            <div class="map-preview" style="background-image: url(../assets/images/backgrounds/background4.png)"></div>
                            <div class="map-name">å¤©ç©ºä¹‹åŸ</div>
                        </div>
                        <div class="map-item" data-map="4">
                            <div class="map-preview" style="background-image: url(../assets/images/backgrounds/background5.png)"></div>
                            <div class="map-name">ç«å±±ç†”å²©</div>
                        </div>
                        <div class="map-item" data-map="5">
                            <div class="map-preview" style="background-image: url(../assets/images/backgrounds/background6.png)"></div>
                            <div class="map-name">å†°é›ªè¦å¡</div>
                        </div>
                    </div>
                </div>
                <div class="map-selection-footer">
                    <button class="main-menu-button secondary" id="backFromMapSelectionBtn">è¿”å›ä¸»èœå•</button>
                </div>
            </div>
        </div>
        

        

        
        <!-- è¿”å›æŒ‰é’® -->
        <div class="exit-button" id="backButton">è¿”å›</div>
        
        <!-- éŸ³é‡æ§åˆ¶ç»„ä»¶ -->
        <div class="volume-control">
            <div class="volume-icon" id="volumeIcon">ğŸ”Š</div>
            <input type="range" id="volumeSlider" min="0" max="100" value="70" class="volume-slider">
            <div class="volume-value" id="volumeValue">70%</div>
        </div>
        
        <!-- ç­‰å¾…æˆ¿é—´ç•Œé¢ -->
        <div class="waiting-room" id="waitingRoom" style="display: none;">
            <div class="waiting-content">
                <h2>ç­‰å¾…å¯¹æ‰‹åŠ å…¥</h2>
                <div class="room-code-display">
                    <p>æˆ¿é—´ä»£ç </p>
                    <div class="code-display" id="waitingRoomId">------</div>
                </div>
                <div class="waiting-animation">
                    <div class="loading-spinner"></div>
                    <p id="waitingMessage">ç­‰å¾…ç©å®¶åŠ å…¥æˆ¿é—´...</p>
                </div>
                <div class="waiting-actions">
                    <button class="primary-button" id="waitingRoomStartGameBtn" style="display: none;">å¼€å§‹æ¸¸æˆ</button>
                    <button class="secondary-button" id="cancelWaitingBtn">å–æ¶ˆç­‰å¾…</button>
                </div>
            </div>
        </div>
        
        <!-- åŠ è½½é¡µé¢ -->
        <div class="loading-page" id="loadingPage">
            <!-- åŠ è½½é¡µé¢è§†é¢‘èƒŒæ™¯ -->
            <video id="loadingBackgroundVideo" autoplay muted loop>
                <source src="../assets/images/mainImage.mp4" type="video/mp4">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
            </video>
            <div class="loading-content">
                <div class="loading-text">æ­£åœ¨åŠ è½½æ¸¸æˆ...</div>
                <div class="loading-bar-container">
                    <div class="loading-bar" id="loadingBar"></div>
                </div>
                <div class="loading-percentage" id="loadingPercentage">0%</div>
            </div>
        </div>

        <script>
            // å…¨å±€éŸ³é‡æ§åˆ¶å˜é‡ï¼ˆä¸control.jsåŒæ­¥ï¼‰
            let globalVolume = 70;
            let isSoundEnabled = true;

            // åŠ è½½è‡ªå®šä¹‰æŠ€èƒ½å›¾æ ‡
            function loadCustomSkillIcons() {
                const skillIcons = {
                    'mana': '../assets/images/icons/mana.png',
                    'fire': '../assets/images/icons/fire.png',
                    'shield': '../assets/images/icons/shield.png',
                    'meteor': '../assets/images/icons/meteor.png',
                    'servant': '../assets/images/icons/servant.png',
                    'blood': '../assets/images/icons/blood.png',
                    'shoot': '../assets/images/icons/shoot.png',
                    'dash': '../assets/images/icons/dash.png',
                    'nuke': '../assets/images/icons/nuke.png',
                    'machine': '../assets/images/icons/machine.png'
                };

                document.querySelectorAll('.skill-cooldown').forEach(skill => {
                    const skillName = skill.dataset.skill;
                    const iconPath = skillIcons[skillName];
                    const skillIcon = skill.querySelector('.skill-icon');

                    if (iconPath && skillIcon) {
                        // å°è¯•åŠ è½½è‡ªå®šä¹‰å›¾æ ‡
                        fetch(iconPath)
                            .then(response => {
                                if (response.ok) {
                                    // å›¾æ ‡å­˜åœ¨ï¼Œä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡
                                    skillIcon.style.backgroundImage = `url('${iconPath}')`;
                                    skillIcon.style.backgroundSize = 'contain';
                                    skillIcon.style.backgroundPosition = 'center';
                                    skillIcon.style.backgroundRepeat = 'no-repeat';
                                } else {
                                    throw new Error('å›¾æ ‡ä¸å­˜åœ¨');
                                }
                            })
                            .catch(error => {
                                // å›¾æ ‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤SVGå›¾æ¡ˆ
                                console.log(`å›¾æ ‡ ${iconPath} ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤SVG`);
                            });
                    }
                });
            }

            // é¡µé¢åŠ è½½å®Œæˆåå°è¯•åŠ è½½è‡ªå®šä¹‰å›¾æ ‡
            document.addEventListener('DOMContentLoaded', loadCustomSkillIcons);

            // æŒ‰é’®å¤„ç†å‡½æ•°
            function handleMapSelection() {
                console.log('é€‰æ‹©åœ°å›¾æŒ‰é’®é€šè¿‡onclickè¢«ç‚¹å‡»');
                const gameMainMenu = document.getElementById('gameMainMenu');
                const mapSelection = document.getElementById('mapSelection');
                if (gameMainMenu && mapSelection) {
                    gameMainMenu.style.display = 'none';
                    mapSelection.style.display = 'block';
                }
            }
            
            function handleLeaderboard() {
                console.log('æ’è¡Œæ¦œæŒ‰é’®é€šè¿‡onclickè¢«ç‚¹å‡»');
                window.location.href = './leaderboard.html';
            }


            document.addEventListener('DOMContentLoaded', function() {
                // è¿”å›æŒ‰é’® - ç»Ÿä¸€è¿”å›åˆ°æ¸¸æˆä¸»èœå•
                const backBtn = document.getElementById('backButton');
                if (backBtn) {
                    backBtn.addEventListener('click', function(e) {
                        console.log('è¿”å›æŒ‰é’®è¢«ç‚¹å‡»ï¼Œè¿”å›åˆ°æ¸¸æˆä¸»èœå•');
                        window.location.href = './game.html';  // è¿”å›åˆ°æ¸¸æˆä¸»èœå•é¡µé¢
                    });
                } else {
                    console.error('è¿”å›æŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°');
                }

                // éŸ³é‡æ§åˆ¶åŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸»è¦æ§åˆ¶ç”±control.jså¤„ç†ï¼‰
                const volumeIcon = document.getElementById('volumeIcon');
                const volumeSlider = document.getElementById('volumeSlider');
                const volumeValue = document.getElementById('volumeValue');

                // æ›´æ–°éŸ³é‡æ˜¾ç¤º
                function updateVolumeDisplay() {
                    if (volumeValue) {
                        volumeValue.textContent = globalVolume + '%';
                    }
                    if (volumeIcon) {
                        if (globalVolume == 0) {
                            volumeIcon.textContent = 'ğŸ”‡';
                        } else if (globalVolume < 30) {
                            volumeIcon.textContent = 'ğŸ”ˆ';
                        } else if (globalVolume < 70) {
                            volumeIcon.textContent = 'ğŸ”‰';
                        } else {
                            volumeIcon.textContent = 'ğŸ”Š';
                        }
                    }
                }

                // åˆå§‹åŒ–éŸ³é‡æ˜¾ç¤º
                updateVolumeDisplay();

                // ç›‘å¬control.jsä¸­çš„éŸ³é‡å˜åŒ–
                window.addEventListener('volumeChanged', function(e) {
                    globalVolume = e.detail.volume;
                    isSoundEnabled = e.detail.enabled;
                    if (volumeSlider) {
                        volumeSlider.value = globalVolume;
                    }
                    updateVolumeDisplay();
                });
            });
        </script>
        <script src ="../scripts/control.js"></script>
        </div>
    </body>
</html>